<div class="container text-center" ng-if="!supportData">
  <i class="fa fa-gear loading-anim f-size-25 p-t-lg"></i>
</div>

<!--TICKET LIST-->
<section ng-if="supportData" class="col-sm-12 col-md-12 col-lg-12 bg-white white-shadow m-t-lg p-b-lg support-table-grid">
  <div class="row">

    <div class="col-lg-12 m-t-lg ">
      <div class="btn btn-default m-r-lg" ng-click="getAllOpenTickets()">All Open Tickets</div>
      <div class="btn btn-default m-r-lg" ng-click="getNoneBillingTickets()">Non-Billing Tickets</div>
      <div class="btn btn-default m-r-lg" ng-click="getBillingTickets()">Billing Tickets</div>
      <div class="btn btn-default m-r-lg" ng-click="getMyTickets()">My Tickets</div>



      <div class="ticket-timing-results block-table-inline pull-right">
        <div class="ttr-container">
          <div class="old-gray   float-left time-data"><label>Total:</label>   {{ticketOpenTime.old}}</div>
          <div class="old-green  float-left time-data"><label><b>></b> 12Hrs.</label> {{ticketOpenTime.old12}}</div>
          <div class="old-yellow float-left time-data"><label><b>></b> 24Hrs.</label> {{ticketOpenTime.old24}}</div>
          <div class="old-red    float-left time-data"><label><b>></b> 48Hrs.</label> {{ticketOpenTime.old48}}</div>
        </div>
      </div>


      <div class="ticket-search-table size-100 m-t-lg">
        <form >
          <label>
            <input type="text" placeholder="Search for Open / Closed Tickets...">
            <i class="fa fa-search pull-right"></i>
          </label>
        </form>
      </div>

    </div>

    <article class="col-lg-12 tickets-history-table m-t-lg table-container">
      <table id="myTable" class="tablesorter table table-striped" datatable="ng" dt-options="dtOptions">
        <thead>
        <tr>
          <th>Ticket</th>
          <th>Status</th>
          <th>Name</th>
          <th>Address</th>
          <th>Tel</th>
          <th>Issue</th>
          <th>Comment</th>
          <th>Assigned</th>
          <th>Update</th>
          <th>Modified</th>
        </tr>
        </thead>
        <tbody>
          <tr ng-repeat="data in supportData" class="{{(data.ticket_history.id_users == 777) ? 'customer-new-updated' : '' }}">
            <td class="first-td" ng-click="displayTicketResume(data.id, data.id_customers)" data-toggle="modal" data-target="#ticketModal">{{data.ticket_number}}</td>
            <td>{{data.status}}</a></td>
            <td><a href="#/customers?id={{data.customer.id}}">{{data.customer.first_name}} {{data.customer.last_name}}</a></td>
            <td>{{data.address.code}} #{{data.address.unit}}</td>
            <td>{{data.contacts.value}}</td>
            <td>{{data.reason.short_description}}</td>

            <td ng-mouseover="showFullComment(data.id)"
                ng-mouseleave="hideFullComment(data.id)"
                ng-if="data.ticket_history.comment"
                class="comment-long">
                {{ data.ticket_history.comment | limitTo:letterLimit }}...
              <div id='ticket-{{ data.id }}' style="display: none;" class="ticket-comment-pop">{{data.ticket_history.comment}}</div>
            </td>

            <td ng-if="!data.ticket_history.comment"> {{data.ticket_history.comment}} </td>

            <td>{{data.user_assigned.first_name ? (data.user_assigned.first_name) : 'AUTO' }}</td>
            <td ng-init="resultDate = convertDate(data.updated_at)">{{resultDate | date : "MMM d, y h:mm a" }}</td>


            <td class="{{data.old}}">
              <!--{{data.updated_at | limitTo : 10}}-->
              <label ng-if="data.old == 'old-red'">> 48Hrs</label>
              <label ng-if="data.old == 'old-yellow'">> 24Hrs.</label>
              <label ng-if="data.old == 'old-green'">> 12Hrs</label>
              <label ng-if="data.old == 'old'">Minutes ago</label>
            </td>
          </tr>
        </tbody>
      </table>
    </article>

  </div>
</section>
<!--END TICKET LIST-->


<!-- MODAL DE TICKET -->
<div class="modal fade" id="ticketModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-ticket-size">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true" ng-click="cancelNewEvent()">
          &times;
        </button>
        <span>Ticket Information</span>
      </div>
      <div class="modal-body">
        <div class="wrapper-sm">
          <div class="row">
            <div class="field-data col-lg-12" >
              <!--Name-->
              <div class="col-lg-12 no-padding-sides">
                <label><strong> {{selectedTicket.customer.first_name + ' ' + selectedTicket.customer.last_name}}</strong></label>
              </div>
              <!--Default Info-->
              <div class="col-lg-3 no-padding-sides">
                <div>Address</div>
                <small class="text-muted">{{selectedTicket.address.address}}</small>
              </div>
              <div class="col-lg-3 no-padding-sides">
                <div>Tel</div>
                <small class="text-muted">{{selectedTicket.contacts.value}}</small>
              </div>
              <div class="col-lg-3 no-padding-sides">
                <div>Email</div>
                <small class="text-muted">{{selectedTicket.customer.email}}</small>
              </div>
              <div class="col-lg-3 no-padding-sides">
                <div>Status</div>
                <small class="text-muted">{{selectedTicket.status}}</small>
              </div>
              <!--Details Info-->
              <div class="col-lg-12 no-padding-sides m-t-lg m-b-sm bg-gray p-b-lg">
                <form id="form-1-ticket">
                  <div class="col-lg-12 no-padding-sides b-t-ddd b-b-ddd m-b-lg" >
                    <div class="pull-left m-t-md">Details:</div>
                    <button class="btn m-b-xs w-xs btn-primary btn-edit ticket-right pull-right m-t-sm m-b-sm"
                            id="block-a"
                            ng-click="editFormByType('block-a')">
                            Edit
                    </button>
                    <button type="submit"
                            class="btn m-b-xs w-xs btn-primary save-btn ticket-right ticket-right-save no-display pull-right m-t-sm m-b-sm m-r-lg"
                            id="save-block-a"
                            ng-click="submitForm('form-1-ticket'); editFormByType('block-a')">
                            Save
                    </button>
                  </div>
                  <div class="col-lg-3 no-padding-sides">
                    <div>Ticket ID </div>
                    <small class="text-muted">{{selectedTicket.ticket_number}}</small>
                  </div>
                  <div class="col-lg-3 no-padding-sides">
                    <div>Issue</div>
                    <small class="text-muted" class="block-a-label">{{selectedTicket.reason.short_description}}</small>
                    <select name="id_reasons" class="block-a-edit form-control no-display">
                      <option value="{{selectedTicket.reason.id}}" >{{selectedTicket.reason.short_description}}</option>
                      <option ng-repeat="desc in dataReasons" value="{{desc.id}}" >{{desc.short_description}}</option>
                    </select>
                  </div>
                  <div class="col-lg-3 no-padding-sides">
                    <div>Status</div>
                    <small class="text-muted">{{selectedTicket.status}}</small>
                    <select name="status" class="block-a-edit form-control no-display">
                      <option value="Escalated" >Escalated</option>
                      <option value="Closed" >Closed</option>
                    </select>
                  </div>
                  <div class="col-lg-3 no-padding-sides">
                    <div>Assigned to</div>
                    <small class="text-muted">{{selectedTicket.user_assigned.first_name ? selectedTicket.user_assigned.first_name : 'Not Set'}}</small>
                    <select name="id_users_assigned" class="block-a-edit form-control no-display">
                      <option value="{{selectedTicket.user_assigned.id}}" >{{selectedTicket.user_assigned.first_name}}</option>
                      <option ng-repeat="usersAssigned in dataUsersAssigned" value="{{usersAssigned.id}}" >{{usersAssigned.first_name}}</option>
                    </select>
                  </div>
                </form>
              </div>
              <!--Comments-->
              <!--
              <div class="col-lg-12 b-t-ddd no-padding-sides p-t-lg p-b-lg m-t-lg">
                <div>Info:</div>
                <div class="comment-content m-b-md">{{selectedTicket.ticket_note.comment}}
                  <p ng-repeat="comment in selectedTicket.ticket_note.ticket_history_full">
                    {{comment.comment}}
                  </p>
                </div>
              </div>
              -->
              <!--Info Left Block-->
              <div class="col-lg-4 no-padding-sides bg-gray">
                <div>Created by</div>
                <small class="text-muted">Auto</small>
                <div class="b-t-ddd m-t-md p-t-lg">Created on</div>
                <small class="text-muted" ng-init="resultDate = convertDate(selectedTicket.created_at)" ng-if="selectedTicket.created_at">{{resultDate | date : "MMM d, y h:mm a" }}</small>
                <div class="b-t-ddd m-t-md p-t-lg">LastUpdate</div>
                <small class="text-muted" ng-init="resultDate = convertDate(selectedTicket.updated_at)" ng-if="selectedTicket.updated_at">{{resultDate | date : "MMM d, y h:mm a" }}</small>
              </div>
              <!--Update History Right Block-->
              <div class="col-lg-8 p-b-lg ">
                <div>History:</div>
                <form id="form-2-ticket">
                  <input type="hidden" name="id_reasons" value="{{selectedTicket.reason.id}}">
                  <input type="hidden" name="id_users_assigned" value="{{selectedTicket.user_assigned.id}}">
                  <textarea name="comment"  placeholder="Go ahead..." class="textarea-main-size thistory-form-2 m-t-sm" value="err" required></textarea>
                  <div class="form-group col-lg-12 suhs no-padding-sides">
                    <label class="control-label">Status: </label>
                    <div class="col-sm-10 no-padding-sides">
                      <label class="suhs-label">Escalate</label>
                      <input type="radio" name="status" checked="" value="escalated">
                      <label class="suhs-label">Close</label>
                      <input type="radio"  name="status" value="closed">
                    </div>
                  </div>
                  <div class="display-content-main-box update-btn-ticket">
                    <button class="btn m-b-xs w-xs btn-primary save-btn display-inline"  ng-click="submitFormUpdate('form-2-ticket')">UPDATE</button>
                  </div>
                </form>
              </div>
              <!--History-->
              <div class="col-lg-12 b-t-ddd no-padding-sides p-t-lg p-b-lg">
                <div>History:</div>
                <div class="thistory-container m-t-sm">
                  <table  class="table table-striped b-b">
                    <thead>
                      <tr>
                        <th>Timestamp</th>
                        <th>Details</th>
                        <th>Status</th>
                        <th>Staff</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr ng-repeat="history in selectedTicket.ticket_history_full" ng-controller="supportTicketHistory">
                        <td ng-init="resultDate = convertDate(history.created_at)" ng-if="history.created_at">{{resultDate | date : "MMM d, y h:mm a" }}</td>
                        <td class="th-comment" height="100">{{history.comment}}</td>
                        <td>{{history.status}}</td>
                        <td>{{dataUsersAssigned[history.id_users].alias}}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>
<!-- END MODAL DE TICKET -->

